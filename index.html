<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>pokepaste-to-molang</title>
    </head>
    <script>
        function convert() {
            var pokemon = [];
            var default_pokemon = {
                "species": "ditto",
                "held_item": "",
                "ability": "imposter",
                "level": 1,
                "shiny": false,
                "happiness": 0,
                "evs": {
                    "hp_ev": -1,
                    "attack_ev": -1,
                    "defense_ev": -1,
                    "special_attack_ev": -1,
                    "special_defense_ev": -1,
                    "speed_ev": -1
                },
                "ivs": {
                    "hp_iv": -1,
                    "attack_iv": -1,
                    "defense_iv": -1,
                    "special_attack_iv": -1,
                    "special_defense_iv": -1,
                    "speed_iv": -1
                },
                "nature": "lax",
                "moves": {
                    "move1": "Transform",
                    "move2": "",
                    "move3": "",
                    "move4": ""
                },
                "uncatchable": true
            };

            for (var i = 0; i < 6; i++) {
                pokemon.push(structuredClone(default_pokemon));
            }

            let eviv_map = {
                "hp": "hp",
                "atk": "attack",
                "def": "defense",
                "spa": "special_attack",
                "spd": "special_defense",
                "spe": "speed"
            };

            var lines = document.getElementById("pokepaste_input").value.split("\n");
            console.log(lines);
            
            var current_pokemon = -1;
            var move_count = 0;
            for (var i = 0; i < lines.length; i++) {
                // check for new Pokemon
                lines[i] = lines[i].trim();
                var test = lines[i];
                if (test.includes("@")) {
                    current_pokemon++;
                    move_count = 0;
                    let species_and_item = test.toLowerCase().split(" @ ");
                    pokemon[current_pokemon]["species"] = species_and_item[0];
                    let item = species_and_item[1].replace(" ", "_");
                    pokemon[current_pokemon]["held_item"] = "cobblemon:" + item;
                    continue;
                }

                // if (current_pokemon == -1) {
                //     // something is wrong with input
                //     break;
                // }

                // try split by ": "
                test = lines[i].toLowerCase().split(": ");
                if (test.length > 1) { // # it was a : line
                    let attr = test[0];
                    if (attr == "evs") {
                        let stats = test[1].trim().split(" ");
                        var current_ev = -1;
                        for (var j = 0; j < stats.length; j++) {
                            let num = parseInt(stats[j]);
                            if (isNaN(num)) {
                                var mapped_stat = eviv_map[stats[j]] || "";
                                if (mapped_stat == "") continue;
                                mapped_stat += "_ev";
                                if (pokemon[current_pokemon]["evs"][mapped_stat] && current_ev >= 0) {
                                    pokemon[current_pokemon]["evs"][mapped_stat] = current_ev;
                                }
                            } else {
                                current_ev = stats[j];
                            }
                        }
                    }
                    else if (attr == "ivs") {
                        let stats = test[1].trim().split(" ");
                        var current_ev = -1;
                        for (var j = 0; j < stats.length; j++) {
                            let num = parseInt(stats[j]);
                            if (isNaN(num)) {
                                var mapped_stat = eviv_map[stats[j]] || "";
                                if (mapped_stat == "") continue;
                                mapped_stat += "_iv";
                                if (pokemon[current_pokemon]["ivs"][mapped_stat] && current_ev >= 0) {
                                    pokemon[current_pokemon]["ivs"][mapped_stat] = current_ev;
                                }
                            } else {
                                current_ev = stats[j];
                            }
                        }
                    }
                    else {
                        if (typeof(pokemon[current_pokemon][attr]) == "boolean") {
                            if (test[1] == "yes") {
                                pokemon[current_pokemon][attr] = true
                            }
                        }
                        else if (typeof(pokemon[current_pokemon][attr]) == "number") { // This isn't working yet it looks like...
                            pokemon[current_pokemon][attr] = Number(test[1])
                        }
                        else if (typeof(pokemon[current_pokemon][attr]) == "string") {
                            pokemon[current_pokemon][attr] = test[1].replace(/ /gi, ""); // I have to do this to replace all, crazy
                        }
                    }
                    continue;
                }

                // check for nature
                test = lines[i].toLowerCase().split(" ")
                if (test.length == 2 && test[1] == "nature") {
                    pokemon[current_pokemon]["nature"] = test[0];
                    continue;
                }

                // check for moves
                test = lines[i].replace(/ /gi, "").toLowerCase();
                if (test[0] == "-") {
                    move_count++;
                    if (move_count > 4) continue;
                    pokemon[current_pokemon]["moves"]["move" + move_count] = test.substring(1, test.length);
                    continue;
                }
            }

            // Convert the dictionary into molang
            let pokemon_count = current_pokemon + 1;
            var output = ""
            for (var i = 0; i < pokemon_count; i++) {
                console.log(pokemon[i]);
                output += "q.party.add_by_properties(\'"

                output += pokemon[i]["species"]
                output += " "

                var moves_text = ""
                for (let key in pokemon[i]["moves"]) {
                    if (pokemon[i]["moves"][key].length > 0) {
                        moves_text += pokemon[i]["moves"][key] + ","
                    }
                }
                if (moves_text.length > 0) {
                    output += "moves=" + moves_text.substring(0, moves_text.length-1) + " "
                }

                output += "nature="
                output += pokemon[i]["nature"]
                output += " "

                output += "held_item=" // insufficient but leave it for now...
                output += pokemon[i]["held_item"]
                output += " "

                output += "ability="
                output += pokemon[i]["ability"]
                output += " "

                for (let key in pokemon[i]["evs"]) {
                    if (pokemon[i]["evs"][key] > 0) {
                        output += key + "=" + pokemon[i]["evs"][key] + " "
                    }
                }

                for (let key in pokemon[i]["ivs"]) {
                    if (pokemon[i]["ivs"][key] >= 0) {
                        output += key + "=" + pokemon[i]["ivs"][key] + " "
                    }
                }

                output += "level="
                output += pokemon[i]["level"]
                output += " "

                if (pokemon[i]["shiny"]) {
                    output += "shiny "
                }

                output = output.substring(0, output.length - 1)
                output += "\');\n"
            }

            document.getElementById("molang_output").value = output;
        }
    </script>

    <body>
        <h1>Pokepaste To Molang Converter</h1>
        <label>How-to:</label>
        <ol>
            <li>Paste your pokepaste from Pokemon Showdown etc. into the first text box.</li>
            <li>Press "Convert".</li>
            <li>Copy the result from the second text box.</li>
            <li>Paste it into a Molang script file for use in Cobblemon.</li>
        </ol>
        <label for="fname">Pokepaste:</label>
        <br>
        <textarea id="pokepaste_input" name="pokepaste_input" rows="20" cols="50" autofocus></textarea>
        <br><br>
        <button onclick="convert()">Convert</button>
        <br><br>
        <label>Molang:</label>
        <br>
        <textarea id="molang_output" name="molang_output" rows="20" cols="50" disabled></textarea>
    </body>
</html>